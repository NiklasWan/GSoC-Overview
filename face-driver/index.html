<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>FACE-Driver - GSoC 2020 Ip Media Streaming</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">GSoC 2020 Ip Media Streaming</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">FACE-Driver</a>
                            </li>
                            <li class="navitem">
                                <a href="../avb-alsa/" class="nav-link">AVB-ALSA</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../avb-alsa/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ctag-face-alsa-driver" class="nav-link">CTAG Face Alsa Driver</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#adjustments" class="nav-link">Adjustments</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#information-on-overlays" class="nav-link">Information on Overlays</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#drivers-for-419-rt" class="nav-link">Drivers for 4.19-rt</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#drivers-for-54-rt" class="nav-link">Drivers for 5.4-rt</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#compilation-and-installation-of-the-kernel-module" class="nav-link">Compilation and installation of the kernel module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ctag-face-alsa-driver">CTAG Face Alsa Driver</h1>
<p>The CTAG Face 2|4 is an audio card for Beaglebone devices, which is equipped with 2 input and 4 output channels. One of the goals for this GSoC project was to port the CTAG Face driver for usage on the BBAI and the BBB to linux kernel 4.19-rt.</p>
<p>WARNING: To use the CTAG Face with the BBAI, stackable headers need to be used. This is due to the height of the passive cooling unit on the CPU.</p>
<h1 id="adjustments">Adjustments</h1>
<p>Here the adjustments, which needed to be made are shown. During the project, I realized, that the linux kernel 4.19-rt is still not running stable on BBAI (As of August, 22 2020). Because of that, I also tried to port the driver to kernel version 5.4-rt, this however failed, because it took too long to adjust for the API changes in ALSA-ASoC API from 4.19 to 5.4.
For both versions, the codec driver of the AD1938 had to be adjusted. This is due to the changes in how overlays are handled on BeagleBoards since kernel version 4.4. Back in that time overlays were loaded using the bone capemanager. A script was handled, how the face was loaded back then. There the reset pin (P8.34) had to be set to HIGH and then to LOW. This is needed to properly start the codec. Because the capemanager is now deprecated the reset functionality is now implemented in the <code>sound/soc/codecs/ad193x.c</code> file. The probe function of the codec is now responsible to reset the codec at startup.</p>
<h2 id="information-on-overlays">Information on Overlays</h2>
<p>During the course of GSoC, another GSoC student at BeagleBoard.org Deepak Khatri worked on a compatibility layer for overlays. Therefore he ported the overlays I created for BBB and BBAI which can be found <a href="https://github.com/NiklasWan/bb.org-overlays/tree/dev_gsoc_face">here</a> to the new overlay repository. The current status is the compatibility update 3 on his repository, which can be found <a href="https://github.com/lorforlinux/BeagleBoard-DeviceTrees/tree/compatibility_Update3">here</a>. The documentation on how overlays are handled now can be found <a href="https://deepaklorkhatri.me/GSoC2020_BeagleBoard.org/">here</a>.
Links to overlays:</p>
<ul>
<li>The implementation of the overlay BBAI (old way) can be found <a href="https://github.com/NiklasWan/bb.org-overlays/blob/dev_gsoc_face/src/arm/BBAI_BB-BONE-FACE-8CH-00A0.dts">here</a></li>
<li>The implementation of the overlay BBB (old way) can be found <a href="https://github.com/NiklasWan/bb.org-overlays/blob/dev_gsoc_face/src/arm/BB-CTAG-SW-8CH-00A0.dts">here</a></li>
<li>The implementation for both overlays (new way) can be found <a href="https://github.com/NiklasWan/BeagleBoard-DeviceTrees/blob/dev_face_fix/src/arm/overlays/BB-CTAG-SW-8CH-00A0.dts">here</a></li>
</ul>
<h2 id="drivers-for-419-rt">Drivers for 4.19-rt</h2>
<p>The implementation of the driver code can be found <a href="https://github.com/NiklasWan/linux/tree/dev_gsoc_face_4.19-rt">here</a></p>
<h2 id="drivers-for-54-rt">Drivers for 5.4-rt</h2>
<p>The implementation for the driver code can be found <a href="https://github.com/NiklasWan/linux/tree/dev_gsoc_face_5.4-rt">here</a></p>
<p>Known issues:
- driver loads and <code>aplay -l</code> and <code>arecord -l</code> list the CTAG Face card, however it can not be controlled via <code>amixer</code> or <code>`alsamixer</code>. This is due to the spi-gpio bitbang driver being not loaded</p>
<h2 id="compilation-and-installation-of-the-kernel-module">Compilation and installation of the kernel module</h2>
<p>The CTAG Face Alsa Driver runs on 4.19-rt, for both BBB and BBAI. To get the Face running on your device, please follow all steps.</p>
<p>IMPORTANT NOTE: The uboot overlay process changed during the course of the project just the BBAI version has been tested until now. For installation on BBB the whole setup has to be done on the internal eMMC chip.</p>
<p>1.) Clone kernel from <a href="https://github.com/NiklasWan/linux/tree/dev_gsoc_face_4.19-rt">here</a></p>
<pre><code>git clone https://github.com/NiklasWan/linux/tree/dev_gsoc_face_4.19-rt
</code></pre>
<p>2.) Load BB device configuration:</p>
<pre><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bb.org_defconfig
</code></pre>
<p>3.) Open menuconfig and Go to Device Drivers - Sound Card Support - Advanced Linux Sound Architecture - ALSA for SoC audio support:
    Enable module build for SoC Audio Support for CTAG face-2-4 Audio Card (AD1938)
4.) Build kernel:</p>
<pre><code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bindeb-pkg -j8
</code></pre>
<p>5.) Download current Image for your device at: https://beagleboard.org/latest-images
6.) Install image using Balena Etcher
7.) Copy built linux image, linux header and linux libc to sd card:</p>
<pre><code>sudo cp linux-* /media/dev/rootfs/home/debian
</code></pre>
<p>8.) Start BB from Sd Card and Install kernel:</p>
<pre><code>sudo dpkg -i linux-headers*

sudo dpkg -i linux-libc*

sudo dpkg -i linux-image*
</code></pre>
<p>9.) Restart:
    sudo reboot
10.) Install bootloader update:
    sudo ./opt/scripts/tools/developers/update_bootloaders.sh
11.) Update system:
    sudo apt update &amp;&amp; sudo apt upgrade
12.) Clone overlay repo:</p>
<pre><code>git clone https://github.com/NiklasWan/BeagleBoard-DeviceTrees.git &amp;&amp; cd BeagleBoard-DeviceTrees &amp;&amp; git checkout compatibility_Update3
</code></pre>
<p>13.) Install overlays:</p>
<pre><code>sudo make install
</code></pre>
<p>13.) Edit Uboot uEnv.txt:</p>
<pre><code>For BBAI:
  add the following lines to /boot/uEnv.txt:
    enable_uboot_overlays=1
    uboot_overlay_addr0=BB-CTAG-SW-8CH-00A0.dtbo
For BBB:
  comment out the following line:

    #enable_uboot_cape_universal=1
  uncomment:

    disable_uboot_overlay_video=1
    disable_uboot_overlay_audio=1
  add:

    uboot_overlay_addr0=BB-CTAG-SW-8CH-00A0.dtbo
</code></pre>
<p>14.) Clone https://github.com/ctag-fh-kiel/ctag-face-2-4.git:</p>
<pre><code>git clone https://github.com/ctag-fh-kiel/ctag-face-2-4.git &amp; cd ctag-face-2-4
</code></pre>
<p>15.) Install alsa config:</p>
<pre><code>cd alsa-configs &amp; sudo cp asound.conf.8ch ~/.asoundrc
</code></pre>
<p>16.) Reboot your board and use the audio card :-)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
